// ══════════════════════════════════════════════════════════════════════════════
// UNIMOBILIARE - Prisma Schema
// ══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────────────────────────────────────

enum Role {
  user
  admin
}

enum SubscriptionStatus {
  trial
  active
  past_due
  canceled
  expired
}

enum SyncStatus {
  idle
  running
  success
  failed
  partial
}

enum ListingStatus {
  active
  sold
  rented
  expired
  duplicate
  flagged
}

enum AuditAction {
  create
  update
  delete
  login
  logout
  view
  export
  impersonate
}

enum TransactionType {
  sale
  rent
}

enum PropertyType {
  apartment
  house
  studio
  land
  commercial
  office
}

enum Currency {
  RON
  EUR
}

enum AlertType {
  email_instant
  email_daily
  email_weekly
  push
}

// ─────────────────────────────────────────────────────────────────────────────
// User & Authentication
// ─────────────────────────────────────────────────────────────────────────────

model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  passwordHash       String             @map("password_hash")
  name               String
  role               Role               @default(user)
  emailVerified      Boolean            @default(false) @map("email_verified")
  emailVerifiedAt    DateTime?          @map("email_verified_at")
  
  // Subscription
  planId             String?            @map("plan_id")
  plan               SubscriptionPlan?  @relation(fields: [planId], references: [id])
  subscriptionStatus SubscriptionStatus @default(trial) @map("subscription_status")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  subscriptionEndsAt DateTime?          @map("subscription_ends_at")
  
  // Stripe
  stripeCustomerId   String?            @unique @map("stripe_customer_id")
  
  // Timestamps
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  deletedAt          DateTime?          @map("deleted_at")
  
  // Relations
  refreshTokens      RefreshToken[]
  searchProfiles     SearchProfile[]
  savedListings      SavedListing[]
  alerts             Alert[]
  auditLogs          AuditLog[]         @relation("AdminAuditLogs")

  @@index([email])
  @@index([planId])
  @@index([subscriptionStatus])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ─────────────────────────────────────────────────────────────────────────────
// Subscription Plans
// ─────────────────────────────────────────────────────────────────────────────

model SubscriptionPlan {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  description    String?
  
  // Pricing (in RON)
  priceMonthly   Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceYearly    Decimal  @map("price_yearly") @db.Decimal(10, 2)
  trialDays      Int      @default(0) @map("trial_days")
  
  // Limits & Features (stored as JSON)
  limits         Json     // { maxSearchProfiles, maxSavedListings, maxAlerts }
  features       Json     // { aiFeatures, priceHistory, exportData, prioritySupport, apiAccess }
  alertTypes     AlertType[]  @map("alert_types")
  
  // Display
  isActive       Boolean  @default(true) @map("is_active")
  isFeatured     Boolean  @default(false) @map("is_featured")
  displayOrder   Int      @default(0) @map("display_order")
  
  // Stripe
  stripePriceIds Json?    @map("stripe_price_ids") // { monthly: string, yearly: string }
  
  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  // Relations
  users          User[]

  @@index([slug])
  @@index([isActive])
  @@map("subscription_plans")
}

// ─────────────────────────────────────────────────────────────────────────────
// Integrations (Platform Adapters)
// ─────────────────────────────────────────────────────────────────────────────

model Integration {
  id              String     @id @default(uuid())
  name            String     @unique
  displayName     String     @map("display_name")
  enabled         Boolean    @default(false)
  
  // No-Code Builder Configuration (stored as JSON)
  sourceConfig    Json       @map("source_config")    // { baseUrl, type, auth, rateLimit, headers }
  listPageConfig  Json       @map("list_page_config") // { listSelector, itemSelector, detailLinkSelector, pagination }
  fieldMappings   Json       @map("field_mappings")   // Array of field mapping objects
  
  // Scheduling
  schedule        String?    // Cron expression
  
  // Sync Status
  lastSyncAt      DateTime?  @map("last_sync_at")
  lastSyncStatus  SyncStatus @default(idle) @map("last_sync_status")
  lastSyncError   String?    @map("last_sync_error")
  listingsCount   Int        @default(0) @map("listings_count")
  
  // Timestamps
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  
  // Relations
  listings        Listing[]
  syncLogs        SyncLog[]

  @@index([name])
  @@index([enabled])
  @@map("integrations")
}

model SyncLog {
  id            String      @id @default(uuid())
  integrationId String      @map("integration_id")
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  status        SyncStatus
  startedAt     DateTime    @map("started_at")
  completedAt   DateTime?   @map("completed_at")
  
  // Stats
  pagesScraped  Int         @default(0) @map("pages_scraped")
  listingsFound Int         @default(0) @map("listings_found")
  listingsNew   Int         @default(0) @map("listings_new")
  listingsUpdated Int       @default(0) @map("listings_updated")
  errors        Int         @default(0)
  
  errorDetails  Json?       @map("error_details")
  
  @@index([integrationId])
  @@index([startedAt])
  @@map("sync_logs")
}

// ─────────────────────────────────────────────────────────────────────────────
// Listings
// ─────────────────────────────────────────────────────────────────────────────

model Listing {
  id              String        @id @default(uuid())
  externalId      String        @map("external_id")
  integrationId   String        @map("integration_id")
  integration     Integration   @relation(fields: [integrationId], references: [id])
  
  // Basic Info
  title           String
  description     String?
  
  // Price
  price           Decimal       @db.Decimal(12, 2)
  currency        Currency      @default(RON)
  pricePerSqm     Decimal?      @map("price_per_sqm") @db.Decimal(10, 2)
  
  // Property Details
  transactionType TransactionType @map("transaction_type")
  propertyType    PropertyType    @map("property_type")
  areaSqm         Decimal?        @map("area_sqm") @db.Decimal(8, 2)
  rooms           Int?
  floor           Int?
  totalFloors     Int?            @map("total_floors")
  yearBuilt       Int?            @map("year_built")
  
  // Location
  city            String
  neighborhood    String?
  street          String?
  latitude        Decimal?        @db.Decimal(10, 8)
  longitude       Decimal?        @db.Decimal(11, 8)
  
  // Media
  images          String[]
  sourceUrl       String          @map("source_url")
  
  // Status & Tracking
  status          ListingStatus   @default(active)
  firstSeenAt     DateTime        @map("first_seen_at")
  lastSeenAt      DateTime        @map("last_seen_at")
  
  // Deduplication
  imageHash       String?         @map("image_hash")
  contentHash     String?         @map("content_hash")
  duplicateOfId   String?         @map("duplicate_of_id")
  duplicateOf     Listing?        @relation("Duplicates", fields: [duplicateOfId], references: [id])
  duplicates      Listing[]       @relation("Duplicates")
  
  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // Relations
  priceHistory    PriceHistory[]
  savedBy         SavedListing[]

  @@unique([integrationId, externalId])
  @@index([city])
  @@index([transactionType, propertyType])
  @@index([price])
  @@index([status])
  @@index([imageHash])
  @@map("listings")
}

model PriceHistory {
  id         String   @id @default(uuid())
  listingId  String   @map("listing_id")
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  price      Decimal  @db.Decimal(12, 2)
  currency   Currency
  recordedAt DateTime @map("recorded_at")

  @@index([listingId])
  @@index([recordedAt])
  @@map("price_history")
}

// ─────────────────────────────────────────────────────────────────────────────
// User Features (Search, Saved, Alerts)
// ─────────────────────────────────────────────────────────────────────────────

model SearchProfile {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  filters         Json            // Search filters as JSON
  isDefault       Boolean         @default(false) @map("is_default")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // Relations
  alerts          Alert[]

  @@index([userId])
  @@map("search_profiles")
}

model SavedListing {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String   @map("listing_id")
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  notes     String?
  savedAt   DateTime @default(now()) @map("saved_at")

  @@unique([userId, listingId])
  @@index([userId])
  @@map("saved_listings")
}

model Alert {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  searchProfileId String?       @map("search_profile_id")
  searchProfile   SearchProfile? @relation(fields: [searchProfileId], references: [id], onDelete: SetNull)
  
  name            String
  type            AlertType
  enabled         Boolean       @default(true)
  
  lastTriggeredAt DateTime?     @map("last_triggered_at")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@map("alerts")
}

// ─────────────────────────────────────────────────────────────────────────────
// Audit Logging
// ─────────────────────────────────────────────────────────────────────────────

model AuditLog {
  id           String      @id @default(uuid())
  timestamp    DateTime    @default(now())
  
  adminId      String      @map("admin_id")
  admin        User        @relation("AdminAuditLogs", fields: [adminId], references: [id])
  adminEmail   String      @map("admin_email")
  
  action       AuditAction
  resourceType String      @map("resource_type")
  resourceId   String?     @map("resource_id")
  
  changes      Json?       // { before, after }
  
  ipAddress    String      @map("ip_address")
  userAgent    String      @map("user_agent")

  @@index([adminId])
  @@index([timestamp])
  @@index([resourceType])
  @@index([action])
  @@map("audit_logs")
}

// ─────────────────────────────────────────────────────────────────────────────
// System Settings
// ─────────────────────────────────────────────────────────────────────────────

model SystemSetting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
